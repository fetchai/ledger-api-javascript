<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: serialization/integer.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: serialization/integer.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {RunTimeError, ValidationError} from '../errors'
import {BN} from 'bn.js'


const LOGS = []
LOGS.push(new BN(256))
LOGS.push(new BN(65536))
LOGS.push(new BN(4294967296))
// over 53 bit number therefore must be passed as hex to BN
LOGS.push(new BN(Buffer.from('FFFFFFFFFFFF9DDB99A168BD2A000000', 'hex')))

/**
 * Determine the number of bytes required to encode the input value.
 * Artificially limited to max of 8 bytes to be compliant
 *
 * @param  {value} calculate log2 num bytes as BN.js object
 */
const _calculate_log2_num_bytes = value => {

    for (let i = 0; i &lt; LOGS.length; i++) {
        if (value.cmp(LOGS[i]) === -1) return i
    }
    throw new RunTimeError(
        'Unable to calculate the number of bytes required for this value'
    )
}

/**
 * Encode a integer value into a bytes buffer
 *
 * @param  {buffer} Bytes data
 * @param  {value} The value to be encoded as a BN.js object
 */
const encode = (buffer, value) => {

    if (!BN.isBN(value)) {
        throw new ValidationError('value to encode must be BN.js object')
    }

    const is_signed = value.isNeg()
    const abs_value = value.abs()

    if (!is_signed &amp;&amp; abs_value.lten(127)) {
        return Buffer.concat([buffer, Buffer.from([abs_value.toNumber()])])
    } else {
        if (is_signed &amp;&amp; abs_value.lten(31)) {
            return Buffer.concat([buffer, Buffer.from([0xE0 | abs_value.toNumber()])])
        } else {
            const log2_num_bytes = _calculate_log2_num_bytes(abs_value)
            const num_bytes = new BN(1).shln(log2_num_bytes)
            const val = (is_signed) ? new BN(0xd0) : new BN(0xc0)
            const header = val.or(new BN(log2_num_bytes).and(new BN(0xF))).toNumber()

            //   encode all the parts fot the values
            let values = Array.from(Array(num_bytes.toNumber()).keys())
                .reverse()
                .map(value => abs_value.shrn(value * 8).and(new BN(0xFF)).toBuffer())
            return Buffer.concat([buffer, Buffer.concat([Buffer.from([header]), Buffer.concat(values)])])
        }
    }
}


const decode = (buffer) => {

    if (buffer.length === 0) {
        throw new ValidationError('Incorrect value being decoded')
    }

    const header = buffer.slice(0, 1)
    buffer = buffer.slice(1)
    const header_integer = header.readUIntBE(0, 1)

    if ((header_integer &amp; 0x80) === 0) {
        return [new BN(header_integer &amp; 0x7F), buffer]
    }

    const type = (header_integer &amp; 0x60) >> 5
    if (type === 3) {
        const decoded = -(header_integer &amp; 0x1f)
        return [new BN(decoded), buffer]
    }

    if (type === 2) {
        const signed_flag = Boolean(header_integer &amp; 0x10)
        const log2_value_length = header_integer &amp; 0x0F
        const value_length = 1 &lt;&lt; log2_value_length
        let slice = buffer.slice(0, value_length)
        let value = new BN(slice)
        buffer = buffer.slice(value_length)

        if (signed_flag) {
            value = value.neg()
        }
        return [value, buffer]
    }
}

export {encode, decode}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ApiEndpoint.html">ApiEndpoint</a></li><li><a href="BitVector.html">BitVector</a></li><li><a href="Entity.html">Entity</a></li></ul><h3>Global</h3><ul><li><a href="global.html#_calculate_log2_num_bytes">_calculate_log2_num_bytes</a></li><li><a href="global.html#encode">encode</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.3</a> on Wed Nov 27 2019 13:25:42 GMT+0530 (India Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
